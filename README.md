## Automatic Trimap Generator ##

##### Keywords: Alpha Compositioning,Trimap #####
##### 關鍵: Alpha合成、三分圖 #####
##### キーワード:アルファチャンネル、マスク画像 #####

## Introduction ##
<ul>
<li/>In image matting, trimap estimates foreground from background by inscribing unknown region
<li/> Mathematically, an image can be represented by the following equation:
</ul>
<p align="center">
<a href="https://www.codecogs.com/eqnedit.php?latex=I_p&space;=&space;\alpha_p&space;F_p&space;&plus;&space;(1-\alpha_p)B_p;\,&space;\alpha_p&space;\in&space;[0,1]" target="_blank"><img src="https://latex.codecogs.com/gif.latex?I_p&space;=&space;\alpha_p&space;F_p&space;&plus;&space;(1-\alpha_p)B_p;\,&space;\alpha_p&space;\in&space;[0,1]" title="I_p = \alpha_p F_p + (1-\alpha_p)B_p;\, \alpha_p \in [0,1]" /></a>
</p>
In this equation, <i>I<sub>p</sub></i> denotes the entire image, <i>F<sub>p</sub></i> denotes a definite foreground, and <i>B<sub>p</sub></i> denotes a definite background. <br/>
On the other hand, <a href="https://www.codecogs.com/eqnedit.php?latex=\alpha_p" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\alpha_p" title="\alpha_p" /></a> is an alpha matte constant with a value ranging between 0 and 1. An <a href="https://www.codecogs.com/eqnedit.php?latex=\alpha_p" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\alpha_p" title="\alpha_p" /></a> value of 0 indicates that the pixel belongs to a background; whereas an <a href="https://www.codecogs.com/eqnedit.php?latex=\alpha_p" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\alpha_p" title="\alpha_p" /></a> value of 1 indicates otherwise. Any <a href="https://www.codecogs.com/eqnedit.php?latex=\alpha_p" target="_blank"><img src="https://latex.codecogs.com/gif.latex?\alpha_p" title="\alpha_p" /></a> value in between means a mixed pixel that has to be determined. <br /><br />

## Descriptions ##
<ul>
  <li/>Generate a trimap (foreground, background, and unknown regions) from an input of binary (mask) image
  <li/>Foreground has a pixel value of 255; background has a pixel value of 0; and unknown has a pixel value of 127
  <li/>In this example, the trimap is generated by extending a binary image of a previously segmented tumor
  <li/>A binary image consists of two parts: foreground (white) which is the tumor and background (black) which is the surrounding region
  <li/>Keep in mind that the unknown region is simply an approximation rather than an exact delineation. Therefore, matting process becomes a crucial key to extract foreground images with exact precision
  <li />All binary images in this repository were generated from <b>U-Net</b> with a <b> Jaccard's Coefficient </b> of 0.94 (out of 1), indicating a high agreement between the ground truth and segmented mask images
  <li />Image erosion feature is added which may anticipate any overestimating foreground issue
</ul>
<br /><b>Input:</b> a binary image (from a segmented lesion)
<br /><b>Output:</b> a trimap with unknown region (gray) from tumor dilation <br/>

## Flow Chart ##
<p align="center"> <img src = "./assets/flowcharts/trimap_flowchart_small.png"> </p>

---
**TO DO:**
- [ ] **Finding The Most Dominant Foreground** -- automatic kernel design (generate an odd-sized matrix from an integer)
- [ ] **Contour Detection Module** -- an alternative method to circumscribe foreground without U-Net segmentation
- [ ] **Mask Contour Module** -- create a binary mask from contour point polygon

## Examples ##
**1 Dilating the binary image (trimap_module.py)** <br/>
```python
import cv2, os, sys
from trimap_module import trimap

path    = "./image/samples/seg_image.png";
image   = extractImage(path);
name    = "testImage";
size    = 10; # how many pixel extension do you want to dilate
number  = 1;  # numbering purpose 
trimap(image, name, size, number, erosion=False)
```
|**FULL IMAGE**| **MASK IMAGE**|**FOREGROUND**| **BACKGROUND**|
|:----------:|:----------:|:----------:|:----------:|
|![alt text](./images/examples/full_img.png)| ![alt text](./images/examples/seg_img.png) |  ![alt text](./images/examples/fg_img.png) | ![alt text](./images/examples/bg_img.png)


|**BINARY IMAGE**|**TRIMAP (10 PX)**|**TRIMAP (20 PX)**|**TRIMAP (30 PX)**|
|:----------:|:----------:|:----------:|:----------:|
|![alt text](./images/examples/seg_img.png)|![alt text](./images/examples/trimap.png)|![alt text](./images/examples/trimap_20.png)|![alt text](./images/examples/trimap_30.png)|

**2 Handling Non-Dominant Foreground (trimap_module.py)**
```python
import cv2, os, sys
from trimap_module import trimap
path    = "./image/test_images/test_image_10.png";
image   = extractImage(path);

kernel  = np.ones( (9,9), np.uint8 ); 
opening = unit01.morph_close(image,kernel);
trimap(opening, "trimap_result", 10, 1, erosion=False)
```
|**NOISES**|**ORIGINAL IMAGES**|**TRIMAPS PREVIOUS**|**TRIMAPS NEW**|
|:----------|:----------:|:----------:|:----------:|
|**Outside FG**|![alt text](./images/examples/opening.png)|![alt text](./images/examples/opening_trimap.png)|![alt text](./images/examples/opening_trimap_new.png)|
|**Inside FG**|![alt text](./images/examples/closing.png)|![alt text](./images/examples/closing_trimap.png)|![alt text](./images/examples/closing_trimap_new.png)|

**3 Impact of Eroding or Expanding Foreground (trimap_class.py)** <br/>
```python
import cv2, os, sys
from trimap_class import trimap
path    = "./image/test_images/test_image_12.png";
image   = extractImage(path);
    
trimap(image, ""trimap_result, 10, 1, DEFG=Erosion, num_iter=3);
```
The illustration starts with zero erosion/dilation; followed with one, three, five, until eleven iterations (an increment of two). <br />

<p>
<table style="margin-left:auto;margin-right:auto;">  
  <tr>
  <th> Erosion </th> <th> Expansion </th>
  </tr>
  <tr>
  <td> <img src = "./images/examples/erosion_effect.gif" height="200" width="200"> </td>
  <td> <img src = "./images/examples/dilation_effect.gif" height="200" width="200"> </td>
  </tr>
</table>
</p><br />


**4 Image Processing using Feature Extraction Module (feature_extraction.py)** <br/>
**Coming Soon**

## References ##
1. Vikas Gupta and Shanmuganathan Raman. (2017). "Automatic Trimap Generation for Image Matting". Indian Institute of Technology, Gandhinagar, IND [download](https://arxiv.org/pdf/1707.00333.pdf)
2. Olivier Juan and Reanud Keriven. (2005). "Trimap Segmentation for Fast and User-Friendly Alpha Matting". FRA [download](http://imagine.enpc.fr/publications/papers/05vlsm_c.pdf)
3. Jimei Yang, Brian Price, Scott Cohen, Honglak Lee, and Ming-Hsuan Yang. (2016). "Object Contour Detection with a Fully Convolutional Encoder-Decoder Network". Adobe Research, USA [download](https://arxiv.org/pdf/1603.04530.pdf)
